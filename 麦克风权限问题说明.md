# 麦克风权限问题说明与解决方案

## 问题描述

PC端浏览器无法调起麦克风，但移动端浏览器可以正常使用。

## 问题原因

现代PC浏览器（Chrome、Edge、Firefox等）对麦克风访问有严格的安全要求：

1. **HTTPS要求**：PC端浏览器要求使用HTTPS协议才能访问麦克风API（`getUserMedia`）
2. **安全上下文**：必须在安全上下文中运行（HTTPS或localhost）
3. **用户交互**：必须在用户交互事件（如点击按钮）中调用麦克风API
4. **权限管理**：浏览器会检查并管理麦克风权限

移动端浏览器通常对localhost或本地IP地址更宽松，所以可能可以正常工作。

## 已实施的解决方案

### 1. HTTPS/安全上下文检查
- 添加了 `isSecureContext()` 函数检查当前环境
- 在访问麦克风前检查是否为HTTPS或localhost
- 如果不是安全上下文，会显示明确的错误提示

### 2. 权限状态检查
- 添加了 `checkMicrophonePermission()` 函数
- 在页面加载时和开始录音前检查权限状态
- 如果权限被拒绝，会提示用户到浏览器设置中允许

### 3. 详细的错误处理
- 针对不同的错误类型提供具体的错误信息：
  - `NotAllowedError`: 权限被拒绝
  - `NotFoundError`: 未检测到麦克风设备
  - `NotReadableError`: 麦克风被其他应用占用
  - `OverconstrainedError`: 无法满足音频约束
  - `SecurityError`: 安全错误（通常是HTTPS问题）

### 4. 页面加载时检查
- 在页面加载时自动检查麦克风可用性
- 如果发现问题，提前提示用户

## 使用建议

### 对于开发环境（localhost）
- 使用 `http://localhost:3005` 访问（通常可以正常工作）
- 如果仍然无法访问，尝试使用 `https://localhost:3005`（需要配置SSL证书）

### 对于生产环境
- **必须使用HTTPS**：配置SSL证书，使用 `https://your-domain.com` 访问
- 可以使用Let's Encrypt等免费SSL证书服务

### 浏览器设置检查
如果仍然无法访问麦克风，请检查：

1. **Chrome/Edge**:
   - 点击地址栏左侧的锁图标
   - 检查"麦克风"权限是否设置为"允许"
   - 如果被阻止，点击"重置权限"或手动设置为"允许"

2. **Firefox**:
   - 点击地址栏左侧的锁图标
   - 检查"使用麦克风"权限
   - 在"权限"设置中允许麦克风访问

3. **Safari**:
   - Safari > 设置 > 网站 > 麦克风
   - 确保网站被允许访问麦克风

### 常见问题排查

1. **错误提示："PC端浏览器需要HTTPS才能访问麦克风"**
   - 解决方案：配置HTTPS或使用localhost访问

2. **错误提示："麦克风权限被拒绝"**
   - 解决方案：在浏览器设置中允许该网站的麦克风权限

3. **错误提示："未检测到麦克风设备"**
   - 解决方案：检查系统麦克风设置，确保麦克风已连接并启用

4. **错误提示："麦克风被其他应用占用"**
   - 解决方案：关闭其他使用麦克风的应用程序（如Zoom、Teams等）

## 代码修改说明

### 主要修改文件
- `static/main.js`

### 新增功能
1. `isSecureContext()`: 检查是否为安全上下文
2. `checkMicrophonePermission()`: 检查麦克风权限状态
3. 增强的 `startRecording()`: 添加了完整的错误处理和权限检查
4. 页面加载时的环境检查

### 修改位置
- 第38-66行：添加了安全上下文和权限检查函数
- 第541-592行：增强了录音启动函数，添加了详细的错误处理
- 第801-817行：在页面加载时添加了环境检查

## 测试建议

1. **本地测试**：
   ```bash
   # 使用HTTP访问localhost
   http://localhost:3005
   ```

2. **HTTPS测试**：
   ```bash
   # 配置SSL后使用HTTPS访问
   https://your-domain.com
   ```

3. **权限测试**：
   - 在浏览器设置中拒绝麦克风权限，测试错误提示
   - 在浏览器设置中允许麦克风权限，测试正常流程

## 技术参考

- [MDN: MediaDevices.getUserMedia()](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)
- [MDN: Permissions API](https://developer.mozilla.org/en-US/docs/Web/API/Permissions_API)
- [Web.dev: 安全上下文](https://web.dev/secure-contexts/)

## 更新日期
2026-02-06
