# 云端部署检查清单

## ✅ 部署前检查

### 1. 域名配置
- [ ] 已准备好域名（如：brainwave.example.com）
- [ ] 域名DNS已指向服务器IP
- [ ] 等待DNS生效（通常几分钟到几小时）

### 2. 服务器环境
- [ ] Python 3.8+ 已安装
- [ ] 虚拟环境已创建并激活
- [ ] 依赖包已安装（`pip install -r requirements.txt`）
- [ ] OpenAI API Key已配置

### 3. HTTPS配置（必须！）

#### 选项A：使用Nginx + Let's Encrypt（推荐）
- [ ] Nginx已安装
- [ ] Certbot已安装
- [ ] Nginx配置文件已创建（参考`nginx.conf.example`）
- [ ] 已运行`certbot --nginx -d your-domain.com`获取证书
- [ ] 防火墙已开放80和443端口
- [ ] Brainwave服务配置为只监听127.0.0.1:3005

#### 选项B：Uvicorn直接使用SSL
- [ ] SSL证书文件已准备好（.key和.crt文件）
- [ ] 证书文件路径已配置在`start_https.sh`中
- [ ] 防火墙已开放3005端口（HTTPS）

### 4. 服务启动
- [ ] 使用systemd或其他进程管理器配置了服务自启动（可选但推荐）
- [ ] 服务已启动并正常运行
- [ ] 检查日志确认无错误

## ✅ 部署后验证

### 1. HTTPS访问测试
- [ ] 访问 `https://your-domain.com` 能正常打开
- [ ] 浏览器地址栏显示锁图标（🔒）
- [ ] 没有SSL证书警告

### 2. 功能测试
- [ ] 页面正常加载
- [ ] WebSocket连接成功（检查浏览器控制台）
- [ ] **点击"开始"按钮能正常调起麦克风** ⭐ 关键测试
- [ ] 录音功能正常
- [ ] 文本转录正常显示

### 3. 浏览器兼容性测试
- [ ] Chrome/Edge（PC端）✅
- [ ] Firefox（PC端）✅
- [ ] Safari（PC端）✅
- [ ] 移动端浏览器 ✅

## 🔧 常见问题排查

### 问题1：PC端无法调起麦克风

**症状**：点击"开始"按钮后，浏览器提示无法访问麦克风

**检查步骤**：
1. ✅ 确认访问地址是 `https://` 而不是 `http://`
2. ✅ 检查浏览器控制台错误信息
3. ✅ 检查浏览器地址栏的锁图标，点击查看权限设置
4. ✅ 确认麦克风权限已允许
5. ✅ 检查Nginx配置中WebSocket部分是否正确

**解决方案**：
- 如果使用HTTP：必须配置HTTPS（见"HTTPS配置"部分）
- 如果权限被拒绝：在浏览器设置中允许麦克风访问
- 如果WebSocket连接失败：检查Nginx配置中的`/api/v1/ws`部分

### 问题2：WebSocket连接失败

**症状**：页面显示"未连接"或连接状态一直显示"连接中"

**检查步骤**：
1. ✅ 检查浏览器控制台的网络标签页
2. ✅ 确认WebSocket URL是 `wss://`（HTTPS环境）或 `ws://`（HTTP环境）
3. ✅ 检查服务器日志：`tail -f /var/log/nginx/brainwave_error.log`
4. ✅ 确认Brainwave服务正在运行：`ps aux | grep uvicorn`
5. ✅ 确认端口3005可访问：`curl http://127.0.0.1:3005`

**解决方案**：
- 检查Nginx配置中的WebSocket代理设置
- 确认`proxy_set_header Upgrade`和`proxy_set_header Connection`已配置
- 检查防火墙设置

### 问题3：SSL证书问题

**症状**：浏览器显示"不安全"或证书警告

**检查步骤**：
1. ✅ 确认证书文件路径正确
2. ✅ 确认证书未过期：`openssl x509 -in cert.pem -noout -dates`
3. ✅ 检查Nginx配置中的证书路径
4. ✅ 确认域名与证书匹配

**解决方案**：
- Let's Encrypt证书：运行`certbot renew`
- 自签名证书：仅用于测试，生产环境应使用Let's Encrypt

## 📝 部署命令速查

### 使用Nginx方案

```bash
# 1. 安装Nginx和Certbot
sudo apt install nginx certbot python3-certbot-nginx

# 2. 配置Nginx（复制nginx.conf.example并修改域名）
sudo cp nginx.conf.example /etc/nginx/sites-available/brainwave
sudo nano /etc/nginx/sites-available/brainwave  # 修改域名

# 3. 启用配置
sudo ln -s /etc/nginx/sites-available/brainwave /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

# 4. 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 5. 启动Brainwave（只监听本地）
uvicorn realtime_server:app --host 127.0.0.1 --port 3005

# 6. 配置防火墙
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

### 使用Uvicorn直接SSL方案

```bash
# 1. 生成自签名证书（仅测试用）
openssl req -x509 -newkey rsa:4096 -nodes \
    -keyout key.pem -out cert.pem \
    -days 365 -subj "/CN=your-domain.com"

# 2. 修改start_https.sh中的证书路径

# 3. 启动服务
./start_https.sh
```

## 🎯 成功标准

部署成功的标志：
1. ✅ 使用HTTPS访问网站
2. ✅ PC端浏览器能正常调起麦克风
3. ✅ 录音和转录功能正常
4. ✅ WebSocket连接稳定
5. ✅ 无浏览器控制台错误

## 📞 需要帮助？

如果遇到问题：
1. 查看`云端部署HTTPS配置指南.md`获取详细步骤
2. 查看`麦克风权限问题说明.md`了解权限相关问题
3. 检查服务器日志和浏览器控制台错误信息

## 更新日期
2026-02-06
